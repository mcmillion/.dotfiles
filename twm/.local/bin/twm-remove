#!/bin/bash
# twm-remove
# Remove a worktree and its tmux session
#
# Usage:
#   twm-remove feature-auth           # remove merged worktree
#   twm-remove                         # remove current worktree (if merged)
#   twm-remove --force feature-auth   # remove even if not merged

set -e

#==============================================================================
# FIND PROJECT ROOT
#==============================================================================

find_project_root() {
  local current_dir="$1"
  local check_dir="$current_dir"

  while [[ "$check_dir" != "/" ]]; do
    if [[ -d "$check_dir/.bare" ]]; then
      echo "$check_dir"
      return 0
    fi
    check_dir=$(dirname "$check_dir")
  done

  # Check if parent has .bare (we're in a worktree)
  check_dir="$current_dir"
  while [[ "$check_dir" != "/" ]]; do
    if [[ -d "$(dirname "$check_dir")/.bare" ]]; then
      dirname "$check_dir"
      return 0
    fi
    check_dir=$(dirname "$check_dir")
  done

  echo "Error: Not in a twm worktree project (no .bare found)" >&2
  return 1
}

#==============================================================================
# MAIN
#==============================================================================

main() {
  local force=false
  local branch=""

  # Parse arguments
  while [[ $# -gt 0 ]]; do
    case "$1" in
      -f|--force)
        force=true
        shift
        ;;
      *)
        branch="$1"
        shift
        ;;
    esac
  done

  local project_root
  project_root=$(find_project_root "$(pwd)") || exit 1

  # If no branch specified, try to detect from current directory
  if [[ -z "$branch" ]]; then
    local current_dir
    current_dir=$(pwd)

    # Check if we're inside a worktree
    if [[ "$current_dir" == "$project_root/"* && "$current_dir" != "$project_root" ]]; then
      # Extract worktree name from path
      local relative_path="${current_dir#$project_root/}"
      branch="${relative_path%%/*}"
    else
      echo "Usage: twm-remove <branch>" >&2
      echo "" >&2
      echo "Examples:" >&2
      echo "  twm-remove feature-auth    # remove specific worktree" >&2
      echo "  cd feature-auth && twm-remove  # remove current worktree" >&2
      exit 1
    fi
  fi

  local worktree_path="$project_root/$branch"

  # Safety check - don't remove main/master
  if [[ "$branch" == "main" || "$branch" == "master" ]]; then
    echo "Error: Refusing to remove '$branch' worktree" >&2
    exit 1
  fi

  # Check worktree exists
  if [[ ! -d "$worktree_path" ]]; then
    echo "Error: Worktree '$branch' not found at $worktree_path" >&2
    exit 1
  fi

  cd "$project_root"

  # Check if branch is merged (unless forcing)
  if [[ "$force" == false ]]; then
    local default_branch
    default_branch=$(git --git-dir=.bare symbolic-ref HEAD 2>/dev/null | sed 's@^refs/heads/@@')

    # Use git branch --list to check if branch is in merged list (handles special chars)
    if ! git --git-dir=.bare branch --merged "$default_branch" --list "$branch" | grep -q .; then
      echo "Error: Branch '$branch' is not merged into '$default_branch'" >&2
      echo "Use --force to remove anyway: twm-remove --force $branch" >&2
      exit 1
    fi
  fi

  echo ""
  echo "Removing worktree '$branch'..."

  # Get session name - twm uses session_name_path_components: 2
  # which gives us "project/branch" format
  local project_name
  project_name=$(basename "$project_root")
  local session_name="$project_name/$branch"

  # Kill tmux session if it exists
  if tmux has-session -t "$session_name" 2>/dev/null; then
    echo "  Killing tmux session '$session_name'..."
    tmux kill-session -t "$session_name"
  fi

  # Remove the worktree
  echo "  Removing git worktree..."
  if [[ "$force" == true ]]; then
    git worktree remove "$branch" --force
  else
    git worktree remove "$branch"
  fi

  # Delete the branch
  echo "  Deleting branch..."
  if [[ "$force" == true ]]; then
    git --git-dir=.bare branch -D "$branch" 2>/dev/null || true
  else
    git --git-dir=.bare branch -d "$branch" 2>/dev/null || true
  fi

  echo ""
  echo "Done! Removed '$branch'"
}

main "$@"
