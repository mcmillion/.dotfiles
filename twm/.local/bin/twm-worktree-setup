#!/bin/bash
# twm-worktree-setup
# Sets up environment for git worktree workspaces
# - Fetches .env.local from 1Password if missing
# - Sets PORT based on project type and worktree index

set -e

#==============================================================================
# FIND PROJECT ROOT (directory containing .bare for worktree setups)
#==============================================================================

find_project_root() {
  local current_dir="$1"
  local check_dir="$current_dir"

  while [[ "$check_dir" != "/" ]]; do
    # Check if parent has .bare (we're in a worktree)
    if [[ -d "$(dirname "$check_dir")/.bare" ]]; then
      dirname "$check_dir"
      return 0
    fi
    check_dir=$(dirname "$check_dir")
  done

  # No .bare found - check if current dir has .bare (we're at project root)
  if [[ -d "$current_dir/.bare" ]]; then
    echo "$current_dir"
    return 0
  fi

  # Not a worktree setup, use git root's parent
  local git_root
  git_root=$(git rev-parse --show-toplevel 2>/dev/null) || return 1
  dirname "$git_root"
}

#==============================================================================
# DETECT ENV FILE NAME BY PROJECT TYPE
#==============================================================================

get_env_filename() {
  # Next.js and Vite use .env.local
  if [[ -f "next.config.js" || -f "next.config.ts" || -f "next.config.mjs" ]]; then
    echo ".env.local"
  elif [[ -f "vite.config.js" || -f "vite.config.ts" || -f "vite.config.mts" ]]; then
    echo ".env.local"
  # Rails, Django, and generic Node use .env
  elif [[ -f "Gemfile" && -f "config/routes.rb" ]]; then
    echo ".env"
  elif [[ -f "manage.py" ]]; then
    echo ".env"
  elif [[ -f "package.json" ]]; then
    echo ".env"
  else
    # Default to .env
    echo ".env"
  fi
}

#==============================================================================
# 1PASSWORD ENVIRONMENT SETUP
#==============================================================================

setup_env_from_1password() {
  local env_file
  env_file=$(get_env_filename)

  # Skip if env file already exists
  if [[ -f "$env_file" ]]; then
    echo "twm-setup: $env_file already exists, skipping..."
    return 0
  fi

  local project_root
  project_root=$(find_project_root "$(pwd)") || {
    echo "twm-setup: Could not determine project root"
    return 1
  }

  # Extract org and project from path
  # ~/Developer/Org/Project -> org=Org, project=Project
  local project org item_name
  project=$(basename "$project_root")
  org=$(basename "$(dirname "$project_root")")

  # Create 1Password item name (lowercase)
  item_name="env-$(echo "$org" | tr '[:upper:]' '[:lower:]')-$(echo "$project" | tr '[:upper:]' '[:lower:]')"

  echo "twm-setup: Looking for 1Password item: $item_name"

  # Try to fetch from 1Password
  if op read "op://Development/$item_name/notesPlain" > "$env_file" 2>/dev/null; then
    echo "twm-setup: Created $env_file from 1Password"
  else
    echo "twm-setup: No 1Password item '$item_name' found, skipping..."
    rm -f "$env_file"
  fi
}

#==============================================================================
# PORT CONFIGURATION
#==============================================================================

setup_port() {
  local project_root
  project_root=$(find_project_root "$(pwd)") || {
    echo "twm-setup: Could not determine project root for port setup"
    return 1
  }

  # Detect project type and set base port
  local base_port=3000
  if [[ -f "next.config.js" || -f "next.config.ts" || -f "next.config.mjs" ]]; then
    base_port=3000
  elif [[ -f "vite.config.js" || -f "vite.config.ts" || -f "vite.config.mts" ]]; then
    base_port=5173
  elif [[ -f "Gemfile" && -f "config/routes.rb" ]]; then
    base_port=3000
  elif [[ -f "manage.py" ]]; then
    base_port=8000
  fi

  # Check for local .twm.yaml override in project root
  local local_config="$project_root/.twm.yaml"
  if [[ -f "$local_config" ]]; then
    local override_port
    override_port=$(grep -E "^base_port:" "$local_config" 2>/dev/null | awk '{print $2}')
    if [[ -n "$override_port" ]]; then
      base_port="$override_port"
    fi
  fi

  # Calculate worktree index (alphabetically sorted, 0-indexed)
  local worktree_name worktree_index
  worktree_name=$(basename "$(pwd)")

  # List sibling directories (excluding .bare) and find our index
  worktree_index=$(ls -1 "$project_root" 2>/dev/null | grep -v "^\.bare$" | sort | grep -n "^${worktree_name}$" | cut -d: -f1)

  if [[ -z "$worktree_index" ]]; then
    worktree_index=1
  fi

  worktree_index=$((worktree_index - 1))

  # Set PORT
  export PORT=$((base_port + worktree_index))
  echo "twm-setup: PORT=$PORT (base: $base_port, index: $worktree_index)"

  # Also update env file if it exists and doesn't have PORT set
  local env_file
  env_file=$(get_env_filename)
  if [[ -f "$env_file" ]] && ! grep -q "^PORT=" "$env_file"; then
    echo "PORT=$PORT" >> "$env_file"
    echo "twm-setup: Added PORT=$PORT to $env_file"
  fi
}

#==============================================================================
# INSTALL DEPENDENCIES
#==============================================================================

install_dependencies() {
  echo "twm-setup: Checking for dependencies to install..."

  # Node.js - detect package manager from lockfile
  if [[ -f "pnpm-lock.yaml" ]]; then
    echo "twm-setup: Installing dependencies with pnpm..."
    pnpm install
  elif [[ -f "yarn.lock" ]]; then
    echo "twm-setup: Installing dependencies with yarn..."
    yarn install
  elif [[ -f "package-lock.json" ]]; then
    echo "twm-setup: Installing dependencies with npm..."
    npm install
  elif [[ -f "package.json" ]]; then
    # No lockfile, default to npm
    echo "twm-setup: Installing dependencies with npm (no lockfile found)..."
    npm install
  fi

  # Ruby
  if [[ -f "Gemfile.lock" ]]; then
    echo "twm-setup: Installing dependencies with bundle..."
    bundle install
  fi

  # Python
  if [[ -f "requirements.txt" ]]; then
    echo "twm-setup: Installing dependencies with pip..."
    pip install -r requirements.txt
  elif [[ -f "pyproject.toml" ]]; then
    if [[ -f "poetry.lock" ]]; then
      echo "twm-setup: Installing dependencies with poetry..."
      poetry install
    elif [[ -f "uv.lock" ]]; then
      echo "twm-setup: Installing dependencies with uv..."
      uv sync
    fi
  fi
}

#==============================================================================
# MAIN
#==============================================================================

main() {
  echo "twm-setup: Setting up worktree environment..."

  setup_env_from_1password
  setup_port
  install_dependencies

  echo "twm-setup: Done"
}

main "$@"
