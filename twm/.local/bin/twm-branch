#!/bin/bash
# twm-branch
# Create a new worktree for a branch
#
# Usage:
#   twm-branch feature-auth           # checkout existing remote branch
#   twm-branch feature-new main       # create new branch from main

set -e

#==============================================================================
# FIND PROJECT ROOT
#==============================================================================

find_project_root() {
  local current_dir="$1"
  local check_dir="$current_dir"

  while [[ "$check_dir" != "/" ]]; do
    if [[ -d "$check_dir/.bare" ]]; then
      echo "$check_dir"
      return 0
    fi
    check_dir=$(dirname "$check_dir")
  done

  echo "Error: Not in a twm worktree project (no .bare found)" >&2
  return 1
}

#==============================================================================
# MAIN
#==============================================================================

main() {
  local branch="$1"
  local base="$2"

  if [[ -z "$branch" ]]; then
    echo "Usage: twm-branch <branch> [base-branch]" >&2
    echo "" >&2
    echo "Examples:" >&2
    echo "  twm-branch feature-auth         # checkout existing remote branch" >&2
    echo "  twm-branch feature-new main     # create new branch from main" >&2
    exit 1
  fi

  local project_root
  project_root=$(find_project_root "$(pwd)") || exit 1

  cd "$project_root"

  echo ""
  echo "Creating worktree for $branch..."

  if [[ -n "$base" ]]; then
    # Create new branch from base
    git --git-dir=.bare worktree add -b "$branch" "$branch" "$base"
    echo "  Created new branch '$branch' from '$base'"
  else
    # Checkout existing remote branch
    git --git-dir=.bare fetch origin
    if git --git-dir=.bare show-ref --verify --quiet "refs/remotes/origin/$branch"; then
      git --git-dir=.bare worktree add "$branch" --track "origin/$branch"
      echo "  Checked out existing branch '$branch' tracking 'origin/$branch'"
    else
      echo "Error: Branch '$branch' not found on remote" >&2
      echo "To create a new branch, specify a base: twm-branch $branch main" >&2
      exit 1
    fi
  fi

  # Open with twm (layout will run twm-worktree-setup)
  twm -p "$project_root/$branch"
}

main "$@"
