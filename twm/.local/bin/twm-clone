#!/bin/bash
# twm-clone
# Clone a git repo as a bare repo with worktree setup
#
# Usage:
#   twm-clone git@github.com:Org/project.git
#   twm-clone https://github.com/Org/project.git

set -e

DEV_DIR="$HOME/Developer"

#==============================================================================
# PARSE GIT URL
#==============================================================================

parse_git_url() {
  local url="$1"
  local org project

  # SSH format: git@github.com:Org/project.git
  if [[ "$url" =~ ^git@[^:]+:([^/]+)/([^/]+)(\.git)?$ ]]; then
    org="${BASH_REMATCH[1]}"
    project="${BASH_REMATCH[2]}"
  # HTTPS format: https://github.com/Org/project.git
  elif [[ "$url" =~ ^https?://[^/]+/([^/]+)/([^/]+)(\.git)?$ ]]; then
    org="${BASH_REMATCH[1]}"
    project="${BASH_REMATCH[2]}"
  else
    echo "Error: Could not parse git URL: $url" >&2
    echo "Expected format:" >&2
    echo "  git@github.com:Org/project.git" >&2
    echo "  https://github.com/Org/project.git" >&2
    exit 1
  fi

  # Remove .git suffix if present
  project="${project%.git}"

  echo "$org" "$project"
}

#==============================================================================
# MAIN
#==============================================================================

main() {
  local url="$1"

  if [[ -z "$url" ]]; then
    echo "Usage: twm-clone <git-url>" >&2
    echo "" >&2
    echo "Examples:" >&2
    echo "  twm-clone git@github.com:Org/project.git" >&2
    echo "  twm-clone https://github.com/Org/project.git" >&2
    exit 1
  fi

  # Parse URL
  read -r org project <<< "$(parse_git_url "$url")"

  local project_dir="$DEV_DIR/$org/$project"

  echo ""
  echo "Cloning $org/$project..."

  # Check if already exists
  if [[ -d "$project_dir" ]]; then
    echo "Error: Directory already exists: $project_dir" >&2
    exit 1
  fi

  # Create directory structure
  mkdir -p "$project_dir"
  cd "$project_dir"

  # Clone as bare repo (cleanup on failure)
  if ! git clone --bare "$url" .bare; then
    echo "Error: Failed to clone repository" >&2
    rm -rf "$project_dir"
    exit 1
  fi

  # Create .git file pointing to bare repo
  echo "gitdir: ./.bare" > .git

  # Detect default branch from bare repo
  local default_branch
  default_branch=$(git --git-dir=.bare symbolic-ref HEAD 2>/dev/null | sed 's@^refs/heads/@@')

  # Fallback: try main, then master
  if [[ -z "$default_branch" ]]; then
    if git --git-dir=.bare show-ref --verify --quiet refs/heads/main; then
      default_branch="main"
    elif git --git-dir=.bare show-ref --verify --quiet refs/heads/master; then
      default_branch="master"
    else
      echo "Error: Could not detect default branch" >&2
      exit 1
    fi
  fi

  # Add default branch as worktree
  git worktree add "$default_branch" "$default_branch"

  # Set up environment from 1Password
  cd "$default_branch"
  if command -v twm-worktree-setup &> /dev/null; then
    twm-worktree-setup
  fi
  cd ..

  echo "  Created: $project_dir/"
  echo "  Bare repo: $project_dir/.bare"
  echo "  Worktree: $project_dir/$default_branch"
  echo ""
  echo "Done! cd $project_dir/$default_branch"
}

main "$@"
